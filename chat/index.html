<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://harithkavish.github.io/style.css" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="icon" href="https://harithkavish.github.io/favicon.svg" type="image/svg+xml" />
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer
        onload="window.onGoogleLibraryLoad && window.onGoogleLibraryLoad();"></script>
    <script src="https://harithkavish.github.io/script.js" defer></script>
    <meta name="google-site-verification" content="SdeY2poCFNBw9AeQhlC5LVYL7NzT0lSyjJR8xMHkto8" />
</head>

<body>
    <div id="sharedHeader"></div>
    <main class="page">

        <div class="layout">
            <section class="panel info">
                <form id="start-chat-form" class="start-form">
                    <div class="input-with-button">
                        <input id="peer-email" name="peer-email" type="email" placeholder="Enter Peer Email ID"
                            required />
                        <button type="submit">→</button>
                    </div>
                </form>

                <div class="section-header">Recent Chats</div>
                <div id="recent-chats" class="recent-chats">
                    <div class="empty">No recent chats</div>
                </div>
            </section>

            <section class="panel chat">
                <div class="chat-header">
                    <div class="chat-header-left">
                        <button id="back-button" class="back-button" style="display: none;">←</button>
                        <div id="chat-peer" class="chat-peer">No peer selected</div>
                    </div>
                    <div class="status" id="auth-status">Signed out</div>
                </div>
                <div id="messages" class="messages">
                    <div class="empty">Sign in and choose a peer to start messaging.</div>
                </div>
                <form id="message-form" class="message-form">
                    <input id="message-input" name="message" type="text" placeholder="Type a message" autocomplete="off"
                        required />
                    <button type="submit">Send</button>
                </form>
            </section>
        </div>
    </main>
    <div id="sharedFooter"></div>
    <script defer>
        const GOOGLE_USER_STORAGE_KEY = 'harith_google_user';

        function getStoredGoogleUser() {
            try {
                const raw = localStorage.getItem(GOOGLE_USER_STORAGE_KEY);
                return raw ? JSON.parse(raw) : null;
            } catch (err) {
                return null;
            }
        }

        function storeGoogleUser(user) {
            if (!user) return;
            localStorage.setItem(GOOGLE_USER_STORAGE_KEY, JSON.stringify(user));
        }

        function clearStoredGoogleUser() {
            localStorage.removeItem(GOOGLE_USER_STORAGE_KEY);
        }

        function extractProfileFromCredential(credential) {
            if (!credential) return null;
            try {
                const payload = credential.split('.')[1];
                const base64 = payload.replace(/-/g, '+').replace(/_/g, '/');
                const decoded = decodeURIComponent(atob(base64)
                    .split('')
                    .map(char => `%${('00' + char.charCodeAt(0).toString(16)).slice(-2)}`)
                    .join(''));
                return JSON.parse(decoded);
            } catch (err) {
                return null;
            }
        }

        function renderSignedInButton(user) {
            const googleButtonTarget = document.getElementById('googleSignInButton');
            if (!googleButtonTarget) return;
            googleButtonTarget.innerHTML = `
                <button type="button" class="signed-in-button" aria-label="Signed in as ${user.name}">
                    <img src="${user.picture || 'https://www.gravatar.com/avatar/?d=mp'}" alt="${user.name} avatar"
                        class="signed-in-button__avatar" loading="lazy" />
                    <span class="signed-in-button__name">${user.name}</span>
                </button>`;
            const signInBtn = googleButtonTarget.querySelector('button');
            signInBtn?.addEventListener('click', () => {
                clearStoredGoogleUser();
                initGoogleSignInButton();
                // Dispatch custom event so body knows to logout
                window.dispatchEvent(new CustomEvent('harith-logout'));
            });
        }

        function handleGoogleCredentialResponse(credentialResponse) {
            const profile = extractProfileFromCredential(credentialResponse?.credential);
            const user = {
                name: profile?.name || 'Signed in',
                picture: profile?.picture || '',
                email: profile?.email || ''
            };
            storeGoogleUser(user);
            renderSignedInButton(user);
            // Call handler in app.js to update the chat app state
            if (window.handleGoogleSignIn) {
                window.handleGoogleSignIn();
            }
        }

        let googleButtonRetries = 0;
        function initGoogleSignInButton() {
            const googleButtonTarget = document.getElementById('googleSignInButton');
            if (!googleButtonTarget) return;
            const storedProfile = getStoredGoogleUser();
            if (storedProfile) {
                renderSignedInButton(storedProfile);
                return;
            }
            if (!window.google?.accounts?.id) {
                if (googleButtonRetries < 10) {
                    googleButtonRetries++;
                    setTimeout(initGoogleSignInButton, 250);
                }
                return;
            }
            googleButtonTarget.innerHTML = '';
            google.accounts.id.initialize({
                client_id: '59648450302-sqkk4pdujkt4hrm0uuhq95pq55b4jg2k.apps.googleusercontent.com',
                callback: handleGoogleCredentialResponse
            });
            google.accounts.id.renderButton(
                googleButtonTarget,
                { theme: 'outline', size: 'medium', type: 'standard', shape: 'pill' }
            );
        }

        function injectChatHeaderAuth(actions) {
            if (!actions || document.getElementById('chat-auth-controls')) return;
            const html = `
                <div id="chat-auth-controls" class="chat-header-actions">
                    <button id="sync-drive" class="ghost" hidden>Sync to Drive</button>
                </div>`;
            actions.insertAdjacentHTML('beforeend', html);
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (window.HarithShell) {
                HarithShell.renderHeader({
                    target: '#sharedHeader',
                    brand: {
                        title: 'Chat',
                        tagline: 'Peer-to-peer chat with Drive persistence'
                    }
                });
                HarithShell.renderFooter({
                    target: '#sharedFooter',
                    text: 'Harith Kavish'
                });
                const actions = document.querySelector('.shared-header__actions');
                injectChatHeaderAuth(actions);
                initGoogleSignInButton();
            }
        });
    </script>
    <script defer src="app.js"></script>
</body>

</html>